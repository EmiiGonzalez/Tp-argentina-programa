package baseDatos;

import java.sql.*;
import java.util.Map;

import lombok.Data;
import modelo.Persona;
import modelo.Resultado;
@Data
public class BaseDeDatos {

	private String driver;
	private String ip;
	private String usuario;
	private String pass;
	private String api;
	private String dbName;
	
	public BaseDeDatos(String api, String ip,String dbName, String usuario, String pass) {
		this.ip = ip;
		this.usuario = usuario;
		this.pass = pass;
		this.api = api;
		this.dbName = dbName;
	}
	public BaseDeDatos() {
	}
	
	public void setDatosEnBase(Resultado datos, String control) {
		
		try {
			Connection con=DriverManager.getConnection("jdbc:"+this.getApi()+"://"+this.getIp()+"/"+this.getDbName(),this.getUsuario(),this.getPass());		//conexion 
			Statement stmt=con.createStatement();  	//objeto para ejecutar comandos sql
			System.out.println("conecto");  
			
			if(control.equals("P")) {
				
				String query = "SELECT * FROM persona";
				PreparedStatement ps = con.prepareStatement(query);		//para preparar la query
				
			
				for (Persona persona : datos.getPuntajeTotalPorPersona().values()) {
					String nombre = persona.getNombre();
					int id = persona.getId();
					int puntaje = persona.getPuntaje();
					ps.setInt(1, id);
					ResultSet rs = ps.executeQuery();
					
					if(rs.next()) {
						PreparedStatement ps2 = con.prepareStatement("UPDATE persona SET nombre = ?, puntajeTotal = ? WHERE id = ?");
						ps2.setString(1, nombre);
						ps2.setInt(2, puntaje);
						ps2.setInt(3, id);
						ps2.executeUpdate();
						System.out.println("Se actualizó el registro con el id " + id);
						ps2.close();
					}	else {
						PreparedStatement ps2 = con.prepareStatement("INSERT INTO persona (id, nombre, puntajeTotal) VALUES (?, ?, ?)");
						ps2.setInt(1, id);
						ps2.setString(2, nombre);
						ps2.setInt(3, puntaje);
						System.out.println("Se creó un nuevo registro con el id " + id);
						ps2.close();
					}
					rs.close();
				}
				
				ps.close();
				con.close();
				
				

			}
			
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
	}
	
}
